import {mkdir, readFile, writeFile} from 'node:fs/promises'
import path from 'node:path'
import {fileURLToPath} from 'node:url'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

const repoRoot = path.resolve(__dirname, '../../..')
const inputPath = path.join(repoRoot, 'packages/unrag/CHANGELOG.md')
const outDir = path.join(repoRoot, 'apps/web/content/_generated')
const outputPath = path.join(outDir, 'changelog-body.mdx')

function stripTopHeader(markdown) {
	const lines = markdown.split(/\r?\n/)
	if (lines.length === 0) return markdown

	// Remove leading blank lines
	while (lines.length > 0 && lines[0].trim() === '') lines.shift()

	// Remove `# unrag` (so the docs page title is the single H1)
	if (lines[0]?.match(/^#\s*unrag\s*$/i)) {
		lines.shift()
		while (lines.length > 0 && lines[0].trim() === '') lines.shift()
	}

	return lines.join('\n')
}

const raw = await readFile(inputPath, 'utf8')
const body = stripTopHeader(raw).trimEnd() + '\n'

await mkdir(outDir, {recursive: true})
await writeFile(
	outputPath,
	`{/* This file is auto-generated by scripts/generate-changelog.mjs. Do not edit directly. */}\n\n${body}`,
	'utf8'
)
